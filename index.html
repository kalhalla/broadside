<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <title>Broadside ‚Äî Book Recommendations from Strangers</title>
  
  <!-- PWA Meta Tags -->
  <meta name="description" content="Share a book that changed you. Receive one from a stranger. No profiles, no algorithms, just ink and intention.">
  <meta name="theme-color" content="#1a1614">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Broadside">
  <link rel="manifest" href="manifest.json">
  
  <!-- Icons -->
  <link rel="icon" type="image/png" sizes="32x32" href="icon-32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="icon-16.png">
  <link rel="apple-touch-icon" sizes="180x180" href="icon-180.png">
  
  <!-- Open Graph / Social -->
  <meta property="og:type" content="website">
  <meta property="og:title" content="Broadside ‚Äî Book Recommendations from Strangers">
  <meta property="og:description" content="Share a book that changed you. Receive one from a stranger.">
  <meta property="og:image" content="og-image.png">
  <meta name="twitter:card" content="summary_large_image">
  
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400;0,700;1,400&family=IM+Fell+English:ital@0;1&family=Special+Elite&display=swap" rel="stylesheet">
  
  <!-- Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    :root {
      --ink: #1a1614;
      --ink-light: #2a2420;
      --cream: #f4f1ea;
      --paper: #e8e4db;
      --red: #8b2500;
      --red-dark: #6b1d00;
      --wood: #3d2b1f;
      --wood-light: #5c4033;
      --gold: #c4a747;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    html, body {
      height: 100%;
    }

    body {
      font-family: 'IM Fell English', serif;
      background: var(--ink);
      color: var(--cream);
      min-height: 100vh;
      overflow-x: hidden;
    }

    /* Noise texture overlay */
    body::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      opacity: 0.03;
      pointer-events: none;
      background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)'/%3E%3C/svg%3E");
      z-index: 1000;
    }

    .container {
      max-width: 600px;
      margin: 0 auto;
      padding: 2rem 1.5rem;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    /* Header */
    header {
      text-align: center;
      padding: 2rem 0 3rem;
    }

    .logo {
      font-family: 'Playfair Display', serif;
      font-size: 3.5rem;
      font-weight: 700;
      letter-spacing: 0.15em;
      text-transform: uppercase;
      margin-bottom: 0.5rem;
      position: relative;
      display: inline-block;
    }

    .logo::before,
    .logo::after {
      content: '‚óÜ';
      font-size: 0.4em;
      position: absolute;
      top: 50%;
      transform: translateY(-50%);
      color: var(--red);
    }

    .logo::before {
      left: -1.5em;
    }

    .logo::after {
      right: -1.5em;
    }

    .tagline {
      font-style: italic;
      font-size: 1.1rem;
      color: var(--gold);
      letter-spacing: 0.05em;
    }

    /* Press illustration */
    .press-illustration {
      width: 320px;
      height: 300px;
      margin: 2rem auto;
      position: relative;
    }

    .press-svg {
      width: 100%;
      height: 100%;
      fill: none;
      stroke: var(--cream);
      stroke-width: 1;
      stroke-linecap: round;
      stroke-linejoin: round;
    }

    .press-svg .lever-group {
      transform-origin: 245px 140px;
      transition: transform 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
    }

    .press-svg.pulled .lever-group {
      transform: rotate(-20deg);
    }

    .press-svg .detail {
      stroke-width: 0.5;
      opacity: 0.6;
    }

    .press-svg .fine {
      stroke-width: 0.3;
      opacity: 0.4;
    }

    .press-svg .accent {
      stroke: var(--gold);
      stroke-width: 1.2;
    }

    .press-svg .heavy {
      stroke-width: 1.8;
    }

    .press-svg .medium {
      stroke-width: 1.2;
    }

    .press-svg .fill-accent {
      fill: var(--gold);
      stroke: var(--gold);
    }

    .press-svg .fill-dark {
      fill: var(--ink);
      stroke: var(--cream);
    }

    .press-svg .crosshatch {
      stroke-width: 0.3;
      opacity: 0.3;
    }

    /* Decorative rule */
    .ornament {
      text-align: center;
      font-size: 1.5rem;
      color: var(--gold);
      margin: 1.5rem 0;
      letter-spacing: 0.5em;
    }

    /* Main content area */
    main {
      flex: 1;
    }

    /* The paper/card where content appears */
    .broadsheet {
      background: var(--cream);
      color: var(--ink);
      padding: 2rem;
      position: relative;
      box-shadow: 
        0 2px 4px rgba(0,0,0,0.3),
        0 8px 16px rgba(0,0,0,0.2);
      margin-bottom: 2rem;
    }

    .broadsheet::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='paper'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.04' numOctaves='5' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23paper)'/%3E%3C/svg%3E");
      opacity: 0.03;
      pointer-events: none;
    }

    .broadsheet-header {
      text-align: center;
      border-bottom: 2px solid var(--ink);
      padding-bottom: 1rem;
      margin-bottom: 1.5rem;
    }

    .broadsheet-title {
      font-family: 'Playfair Display', serif;
      font-size: 1.2rem;
      text-transform: uppercase;
      letter-spacing: 0.2em;
    }

    .broadsheet-date {
      font-size: 0.85rem;
      font-style: italic;
      margin-top: 0.25rem;
      color: var(--ink-light);
    }

    /* Form elements */
    .form-group {
      margin-bottom: 1.5rem;
    }

    label {
      display: block;
      font-size: 0.9rem;
      text-transform: uppercase;
      letter-spacing: 0.1em;
      margin-bottom: 0.5rem;
      color: var(--ink-light);
    }

    input[type="text"],
    textarea {
      width: 100%;
      padding: 0.75rem;
      font-family: 'Special Elite', monospace;
      font-size: 1rem;
      background: var(--paper);
      border: 1px solid var(--ink-light);
      color: var(--ink);
      transition: all 0.2s;
    }

    input[type="text"]:focus,
    textarea:focus {
      outline: none;
      border-color: var(--red);
      box-shadow: 0 0 0 2px rgba(139, 37, 0, 0.1);
    }

    textarea {
      min-height: 100px;
      resize: vertical;
      line-height: 1.6;
    }

    .char-count {
      text-align: right;
      font-size: 0.8rem;
      color: var(--ink-light);
      margin-top: 0.25rem;
    }

    /* Buttons */
    .btn {
      display: block;
      width: 100%;
      padding: 1rem 2rem;
      font-family: 'Playfair Display', serif;
      font-size: 1.1rem;
      text-transform: uppercase;
      letter-spacing: 0.15em;
      border: none;
      cursor: pointer;
      transition: all 0.3s;
      position: relative;
      overflow: hidden;
    }

    .btn-primary {
      background: var(--red);
      color: var(--cream);
      border: 2px solid var(--red-dark);
    }

    .btn-primary:hover {
      background: var(--red-dark);
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(139, 37, 0, 0.3);
    }

    .btn-primary:active {
      transform: translateY(0);
    }

    .btn-secondary {
      background: transparent;
      color: var(--cream);
      border: 1px solid var(--cream);
      margin-top: 1rem;
    }

    .btn-secondary:hover {
      background: var(--cream);
      color: var(--ink);
    }

    /* Received recommendation display */
    .recommendation {
      text-align: center;
    }

    .book-title {
      font-family: 'Playfair Display', serif;
      font-size: 1.8rem;
      font-weight: 700;
      margin-bottom: 1rem;
      line-height: 1.3;
    }

    .book-reason {
      font-size: 1.15rem;
      font-style: italic;
      line-height: 1.7;
      margin-bottom: 1.5rem;
    }

    .recommendation-meta {
      font-size: 0.85rem;
      color: var(--ink-light);
      padding-top: 1rem;
      border-top: 1px solid var(--ink-light);
    }

    .btn-amazon {
      display: inline-block;
      padding: 0.75rem 1.5rem;
      font-family: 'IM Fell English', serif;
      font-size: 1rem;
      color: var(--ink);
      background: var(--gold);
      border: 1px solid #a08930;
      text-decoration: none;
      margin-bottom: 1.5rem;
      transition: all 0.2s;
    }

    .btn-amazon:hover {
      background: #d4b84a;
      transform: translateY(-1px);
      box-shadow: 0 2px 8px rgba(196, 167, 71, 0.3);
    }

    .btn-share {
      background: var(--ink);
      color: var(--gold);
      border: 2px solid var(--gold);
      margin-bottom: 0.5rem;
    }

    .btn-share:hover {
      background: var(--gold);
      color: var(--ink);
    }

    .share-buttons {
      display: flex;
      gap: 0.5rem;
      margin-bottom: 0.5rem;
    }

    .share-buttons .btn-share {
      flex: 1;
      margin-bottom: 0;
    }

    .toast {
      position: fixed;
      bottom: 2rem;
      left: 50%;
      transform: translateX(-50%);
      background: var(--ink);
      color: var(--gold);
      padding: 1rem 2rem;
      border: 1px solid var(--gold);
      font-family: 'IM Fell English', serif;
      opacity: 0;
      transition: opacity 0.3s;
      z-index: 1001;
    }

    .toast.show {
      opacity: 1;
    }

    /* States */
    .view {
      display: none;
    }

    .view.active {
      display: block;
      animation: fadeIn 0.5s ease;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    @keyframes paperSlide {
      from {
        opacity: 0;
        transform: translateY(-30px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .paper-emerge {
      animation: paperSlide 0.6s cubic-bezier(0.34, 1.56, 0.64, 1);
    }

    /* Footer */
    footer {
      text-align: center;
      padding: 2rem 0;
      font-size: 0.85rem;
      color: var(--wood-light);
      font-style: italic;
    }

    footer a {
      color: var(--gold);
      text-decoration: none;
    }

    footer a:hover {
      text-decoration: underline;
    }

    /* Loading state */
    .loading {
      text-align: center;
      padding: 3rem;
    }

    .spinner {
      width: 40px;
      height: 40px;
      border: 3px solid var(--paper);
      border-top-color: var(--red);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 1rem;
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }

    /* Intro text */
    .intro {
      text-align: center;
      margin-bottom: 2rem;
      line-height: 1.8;
      font-size: 1.1rem;
    }

    .intro strong {
      color: var(--gold);
    }

    /* Responsive */
    @media (max-width: 480px) {
      .logo {
        font-size: 2.5rem;
      }
      
      .logo::before,
      .logo::after {
        display: none;
      }

      .broadsheet {
        padding: 1.5rem;
      }

      .book-title {
        font-size: 1.5rem;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1 class="logo">Broadside</h1>
      <p class="tagline">Book recommendations, pressed by strangers</p>
      
      <div class="press-illustration">
        <svg class="press-svg" id="press-svg" viewBox="0 0 320 300">
          <!-- ========== BASE AND FEET ========== -->
          <!-- Left ornate leg -->
          <path class="heavy" d="M50 280 Q30 280 25 265 Q22 250 30 240 L45 235 Q55 232 60 225 L60 215" />
          <path class="medium" d="M35 275 Q30 270 32 262" />
          <path class="detail" d="M40 270 Q38 265 40 258" />
          <!-- Left leg scrollwork -->
          <path class="detail" d="M28 255 Q22 250 28 245 Q34 240 28 235" />
          <path class="fine" d="M32 252 Q28 248 32 244" />
          
          <!-- Right ornate leg -->
          <path class="heavy" d="M270 280 Q290 280 295 265 Q298 250 290 240 L275 235 Q265 232 260 225 L260 215" />
          <path class="medium" d="M285 275 Q290 270 288 262" />
          <path class="detail" d="M280 270 Q282 265 280 258" />
          <!-- Right leg scrollwork -->
          <path class="detail" d="M292 255 Q298 250 292 245 Q286 240 292 235" />
          <path class="fine" d="M288 252 Q292 248 288 244" />
          
          <!-- Floor line -->
          <path class="medium" d="M20 282 L300 282" />
          <path class="detail" d="M25 285 L295 285" />
          
          <!-- Base platform -->
          <path class="heavy" d="M55 235 L265 235 L268 245 L52 245 Z" />
          <path class="detail" d="M58 238 L262 238" />
          <path class="detail" d="M56 242 L264 242" />
          <!-- Base crosshatching -->
          <path class="crosshatch" d="M70 236 L65 244" />
          <path class="crosshatch" d="M90 236 L85 244" />
          <path class="crosshatch" d="M110 236 L105 244" />
          <path class="crosshatch" d="M130 236 L125 244" />
          <path class="crosshatch" d="M150 236 L145 244" />
          <path class="crosshatch" d="M170 236 L165 244" />
          <path class="crosshatch" d="M190 236 L185 244" />
          <path class="crosshatch" d="M210 236 L205 244" />
          <path class="crosshatch" d="M230 236 L225 244" />
          <path class="crosshatch" d="M250 236 L245 244" />
          
          <!-- ========== MAIN FRAME ========== -->
          <!-- Left upright with Victorian curves -->
          <path class="heavy" d="M60 215 L60 140 Q60 125 70 115 Q85 100 95 80" />
          <path class="medium" d="M65 210 L65 145 Q65 132 73 122" />
          <path class="detail" d="M58 180 Q52 175 58 170" />
          <path class="detail" d="M58 160 Q52 155 58 150" />
          
          <!-- Right upright with Victorian curves -->
          <path class="heavy" d="M260 215 L260 140 Q260 125 250 115 Q235 100 225 80" />
          <path class="medium" d="M255 210 L255 145 Q255 132 247 122" />
          <path class="detail" d="M262 180 Q268 175 262 170" />
          <path class="detail" d="M262 160 Q268 155 262 150" />
          
          <!-- Cross beam with ornament -->
          <path class="heavy" d="M65 155 L255 155" />
          <path class="detail" d="M70 152 L250 152" />
          <path class="detail" d="M70 158 L250 158" />
          <!-- Beam center ornament -->
          <circle cx="160" cy="155" r="8" class="medium" />
          <circle cx="160" cy="155" r="4" class="detail" />
          <circle cx="160" cy="155" r="1.5" class="fill-accent" />
          
          <!-- ========== INK DISK (left side) ========== -->
          <circle cx="45" cy="120" r="32" class="heavy" />
          <circle cx="45" cy="120" r="26" class="medium" />
          <circle cx="45" cy="120" r="20" class="detail" />
          <circle cx="45" cy="120" r="14" class="detail" />
          <circle cx="45" cy="120" r="8" class="detail" />
          <circle cx="45" cy="120" r="3" class="fill-accent" />
          <!-- Ink disk spokes -->
          <path class="fine" d="M45 90 L45 150" />
          <path class="fine" d="M15 120 L75 120" />
          <path class="fine" d="M24 99 L66 141" />
          <path class="fine" d="M24 141 L66 99" />
          <!-- Ink disk roller arm -->
          <path class="medium" d="M72 105 L95 125 L100 140" />
          <circle cx="72" cy="105" r="4" />
          <circle cx="100" cy="140" r="5" />
          <circle cx="100" cy="140" r="2" class="fill-accent" />
          
          <!-- ========== MAIN FLYWHEEL ========== -->
          <circle cx="160" cy="75" r="35" class="heavy" />
          <circle cx="160" cy="75" r="30" class="medium" />
          <circle cx="160" cy="75" r="24" class="detail" />
          <circle cx="160" cy="75" r="10" class="medium" />
          <circle cx="160" cy="75" r="5" class="fill-dark" />
          <circle cx="160" cy="75" r="2" class="fill-accent" />
          <!-- Flywheel spokes (12) -->
          <path class="detail" d="M160 45 L160 55" />
          <path class="detail" d="M160 95 L160 105" />
          <path class="detail" d="M130 75 L140 75" />
          <path class="detail" d="M180 75 L190 75" />
          <path class="detail" d="M139 54 L146 61" />
          <path class="detail" d="M174 89 L181 96" />
          <path class="detail" d="M181 54 L174 61" />
          <path class="detail" d="M146 89 L139 96" />
          <path class="fine" d="M145 49 L150 56" />
          <path class="fine" d="M170 94 L175 101" />
          <path class="fine" d="M175 49 L170 56" />
          <path class="fine" d="M150 94 L145 101" />
          <!-- Flywheel rim detail -->
          <path class="fine" d="M160 42 Q165 42 168 45" />
          <path class="fine" d="M160 108 Q155 108 152 105" />
          
          <!-- ========== ROCKER ARM MECHANISM ========== -->
          <path class="heavy" d="M95 80 Q130 65 160 65 Q190 65 225 80" />
          <path class="detail" d="M100 77 Q130 63 160 63 Q190 63 220 77" />
          
          <!-- Connecting rods with joints -->
          <path class="medium" d="M115 85 L90 140" />
          <path class="medium" d="M205 85 L230 140" />
          <circle cx="115" cy="85" r="4" />
          <circle cx="205" cy="85" r="4" />
          <circle cx="90" cy="140" r="5" />
          <circle cx="230" cy="140" r="5" />
          <circle cx="115" cy="85" r="1.5" class="fill-accent" />
          <circle cx="205" cy="85" r="1.5" class="fill-accent" />
          <circle cx="90" cy="140" r="2" class="fill-accent" />
          <circle cx="230" cy="140" r="2" class="fill-accent" />
          
          <!-- ========== PLATEN (pressing surface) ========== -->
          <path class="heavy" d="M80 165 L240 165 L250 215 L70 215 Z" />
          <path class="medium" d="M85 172 L235 172" />
          <path class="detail" d="M83 180 L237 180" />
          <path class="detail" d="M80 190 L240 190" />
          <path class="detail" d="M75 200 L245 200" />
          <path class="detail" d="M72 210 L248 210" />
          <!-- Platen crosshatching for depth -->
          <path class="crosshatch" d="M95 166 L88 214" />
          <path class="crosshatch" d="M115 166 L108 214" />
          <path class="crosshatch" d="M135 166 L128 214" />
          <path class="crosshatch" d="M155 166 L148 214" />
          <path class="crosshatch" d="M175 166 L168 214" />
          <path class="crosshatch" d="M195 166 L188 214" />
          <path class="crosshatch" d="M215 166 L208 214" />
          <path class="crosshatch" d="M235 166 L228 214" />
          
          <!-- Paper bed/chase -->
          <path class="heavy" d="M75 218 L245 218 L248 232 L72 232 Z" />
          <path class="detail" d="M80 222 L240 222" />
          <path class="detail" d="M78 228 L242 228" />
          
          <!-- ========== LEVER GROUP (animated) ========== -->
          <g class="lever-group">
            <!-- Main lever arm with taper -->
            <path class="heavy accent" d="M245 140 Q252 110 255 80 Q258 55 262 35 Q265 20 270 10" />
            <path class="medium accent" d="M242 138 Q248 110 252 82" />
            <!-- Lever decorative curves -->
            <path class="detail accent" d="M250 100 Q255 98 252 92" />
            <path class="detail accent" d="M255 70 Q260 68 257 62" />
            <!-- Lever handle (ball grip) -->
            <ellipse cx="272" cy="8" rx="12" ry="7" class="accent heavy" />
            <ellipse cx="272" cy="8" rx="8" ry="4" class="detail accent" />
            <path class="fine accent" d="M264 6 Q272 2 280 6" />
            <circle cx="272" cy="8" r="2" class="fill-accent" />
            <!-- Lever pivot mechanism -->
            <circle cx="245" cy="140" r="8" class="heavy" />
            <circle cx="245" cy="140" r="5" class="medium" />
            <circle cx="245" cy="140" r="2.5" class="fill-accent" />
          </g>
          
          <!-- ========== DECORATIVE ELEMENTS ========== -->
          <!-- Victorian scrollwork on frame -->
          <path class="detail" d="M60 200 Q50 195 55 185 Q60 180 55 175" />
          <path class="detail" d="M260 200 Q270 195 265 185 Q260 180 265 175" />
          
          <!-- Small ornamental bolts -->
          <circle cx="60" cy="170" r="2" class="fill-dark" />
          <circle cx="60" cy="190" r="2" class="fill-dark" />
          <circle cx="260" cy="170" r="2" class="fill-dark" />
          <circle cx="260" cy="190" r="2" class="fill-dark" />
          <circle cx="80" cy="232" r="2" class="fill-dark" />
          <circle cx="240" cy="232" r="2" class="fill-dark" />
          
          <!-- Type chase detail (where letters go) -->
          <rect x="110" y="185" width="100" height="25" rx="2" class="detail" />
          <path class="fine" d="M115 190 L205 190" />
          <path class="fine" d="M115 195 L205 195" />
          <path class="fine" d="M115 200 L205 200" />
          <path class="fine" d="M115 205 L205 205" />
        </svg>
      </div>
    </header>

    <main>
      <!-- Home View -->
      <div class="view active" id="home-view">
        <p class="intro">
          Share a book that moved you.<br>
          <strong>Receive one from a stranger.</strong><br>
          No algorithms. No profiles. Just ink and intention.
        </p>
        
        <button class="btn btn-primary" onclick="showView('submit-view')">
          Set Your Type
        </button>
        <button class="btn btn-secondary" onclick="findRecommendation()">
          Pull a Broadside
        </button>
      </div>

      <!-- Submit View -->
      <div class="view" id="submit-view">
        <div class="broadsheet">
          <div class="broadsheet-header">
            <div class="broadsheet-title">Set Your Type</div>
            <div class="broadsheet-date">A book worth sharing</div>
          </div>
          
          <form id="submit-form" onsubmit="submitRecommendation(event)">
            <div class="form-group">
              <label for="book-title">The Book</label>
              <input 
                type="text" 
                id="book-title" 
                name="title" 
                placeholder="Title & Author"
                required
                maxlength="150"
              >
            </div>
            
            <div class="form-group">
              <label for="book-reason">Why It Matters</label>
              <textarea 
                id="book-reason" 
                name="reason" 
                placeholder="In one breath, tell a stranger why..."
                required
                maxlength="280"
                oninput="updateCharCount(this)"
              ></textarea>
              <div class="char-count"><span id="char-count">0</span> / 280</div>
            </div>
            
            <button type="submit" class="btn btn-primary">
              Pull the Press
            </button>
          </form>
        </div>
        
        <button class="btn btn-secondary" onclick="showView('home-view')">
          ‚Üê Back
        </button>
      </div>

      <!-- Loading View -->
      <div class="view" id="loading-view">
        <div class="loading">
          <div class="spinner"></div>
          <p>Pulling the press...</p>
        </div>
      </div>

      <!-- Result View -->
      <div class="view" id="result-view">
        <div class="broadsheet paper-emerge" id="result-paper">
          <div class="broadsheet-header">
            <div class="broadsheet-title">A Broadside for You</div>
            <div class="broadsheet-date" id="result-date"></div>
          </div>
          
          <div class="recommendation">
            <h2 class="book-title" id="result-title"></h2>
            <p class="book-reason" id="result-reason"></p>
            <a href="#" id="amazon-link" class="btn-amazon" target="_blank" rel="noopener noreferrer">
              Find This Book ‚Üí
            </a>
            <p class="recommendation-meta">
              Pressed by a stranger, found by you.
            </p>
          </div>
        </div>
        
        <div class="share-buttons">
          <button class="btn btn-share" onclick="generateShareCard()">
            ‚¨á Download Image
          </button>
          <button class="btn btn-share" onclick="copyLink()">
            üîó Copy Link
          </button>
        </div>
        <button class="btn btn-primary" onclick="showView('submit-view')">
          Share Your Own
        </button>
        <button class="btn btn-secondary" onclick="findRecommendation()">
          Find Another
        </button>
      </div>
      
      <!-- Hidden canvas for image generation -->
      <canvas id="share-canvas" style="display: none;"></canvas>
      
      <!-- Toast notification -->
      <div class="toast" id="toast">Link copied!</div>

      <!-- Thank You View -->
      <div class="view" id="thankyou-view">
        <div class="broadsheet paper-emerge">
          <div class="broadsheet-header">
            <div class="broadsheet-title">Pressed & Sent</div>
            <div class="broadsheet-date">Your recommendation awaits a stranger</div>
          </div>
          
          <div class="recommendation">
            <p class="book-reason">
              Your book has been added to the press. Somewhere, someone will discover it and perhaps it will change their afternoon, their week, their life.
            </p>
          </div>
        </div>
        
        <button class="btn btn-primary" onclick="findRecommendation()">
          Pull a Broadside
        </button>
        <button class="btn btn-secondary" onclick="showView('home-view')">
          ‚Üê Home
        </button>
      </div>
    </main>

    <footer>
      Made with care for readers everywhere
    </footer>
  </div>

  <script>
    // =====================
    // CONFIGURATION
    // =====================
    
    // Set to false once Supabase is configured
    const USE_DEMO_MODE = false;
    
    // Supabase credentials
    const SUPABASE_URL = 'https://gjvdduktsfgnzwovsdib.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdqdmRkdWt0c2Znbnp3b3ZzZGliIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk2MzA5MjEsImV4cCI6MjA4NTIwNjkyMX0.LjUNh1MTLsevRW1ZdOHHX_YQ7Y08tonZNoZyXUiDyQo';
    
    // Amazon Associates tag - replace with your tag
    const AMAZON_AFFILIATE_TAG = 'kalhalla-21';
    
    // Supabase client - only loaded when not in demo mode
    let supabaseClient = null;
    
    // Initialize Supabase client
    function initSupabase() {
      if (!USE_DEMO_MODE && SUPABASE_URL !== 'YOUR_SUPABASE_URL') {
        try {
          supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
          console.log('Supabase initialized successfully');
        } catch (e) {
          console.error('Supabase failed to initialize:', e);
        }
      }
    }
    
    // =====================
    // DEMO DATA
    // =====================
    
    const seedRecommendations = [
      {
        title: "The Master and Margarita by Mikhail Bulgakov",
        reason: "It taught me that the devil might be the only honest character in any story, and that love can chase you across centuries if it's stubborn enough.",
        created_at: "2025-12-28"
      },
      {
        title: "Piranesi by Susanna Clarke",
        reason: "A book about finding beauty in imprisonment, and the terrifying moment when you realize the walls you've memorized might be a cage.",
        created_at: "2025-12-29"
      },
      {
        title: "The Remains of the Day by Kazuo Ishiguro",
        reason: "The quietest devastation I've ever read. A man realizes too late that dignity was a cage he built around himself.",
        created_at: "2025-12-30"
      },
      {
        title: "Blood Meridian by Cormac McCarthy",
        reason: "Violence as poetry. It ruined me for a week and I'm still not sure I've recovered. The Judge will haunt your dreams.",
        created_at: "2025-12-27"
      },
      {
        title: "A Wizard of Earthsea by Ursula K. Le Guin",
        reason: "The only book that made me understand that running from yourself is the real magic, and the only spell worth learning is your own true name.",
        created_at: "2025-12-25"
      },
      {
        title: "Giovanni's Room by James Baldwin",
        reason: "Shame and desire, tangled so tight you can't tell them apart. Baldwin writes sentences that feel like confessions.",
        created_at: "2025-12-26"
      },
      {
        title: "Project Hail Mary by Andy Weir",
        reason: "Pure joy disguised as hard science fiction. I laughed, I cried, I immediately started it again.",
        created_at: "2025-12-24"
      },
      {
        title: "Circe by Madeline Miller",
        reason: "A witch on an island, learning that loneliness can be power if you let it transform you instead of break you.",
        created_at: "2025-12-23"
      }
    ];

    // =====================
    // STATE
    // =====================
    
    let userFingerprint = null;

    // =====================
    // FUNCTIONS
    // =====================

    function generateFingerprint() {
      // Simple fingerprint based on localStorage
      let fp = localStorage.getItem('broadside_fingerprint');
      if (!fp) {
        fp = 'user_' + Math.random().toString(36).substr(2, 9) + Date.now();
        localStorage.setItem('broadside_fingerprint', fp);
      }
      return fp;
    }

    function getStoredRecommendations() {
      const stored = localStorage.getItem('broadside_recommendations');
      if (stored) {
        return JSON.parse(stored);
      }
      // Initialize with seed data
      localStorage.setItem('broadside_recommendations', JSON.stringify(seedRecommendations));
      return seedRecommendations;
    }

    async function saveRecommendation(title, reason) {
      if (USE_DEMO_MODE) {
        const recommendations = getStoredRecommendations();
        const newRec = {
          title: title,
          reason: reason,
          created_at: new Date().toISOString().split('T')[0],
          fingerprint: userFingerprint
        };
        recommendations.push(newRec);
        localStorage.setItem('broadside_recommendations', JSON.stringify(recommendations));
        return newRec;
      } else {
        const { data, error } = await supabaseClient
          .from('recommendations')
          .insert([{ 
            title: title, 
            reason: reason, 
            fingerprint: userFingerprint 
          }])
          .select();
        
        if (error) {
          console.error('Error saving:', error);
          return null;
        }
        return data[0];
      }
    }

    async function getRandomRecommendation() {
      if (USE_DEMO_MODE) {
        const recommendations = getStoredRecommendations();
        const available = recommendations.filter(r => r.fingerprint !== userFingerprint);
        if (available.length === 0) {
          return recommendations[Math.floor(Math.random() * recommendations.length)];
        }
        return available[Math.floor(Math.random() * available.length)];
      } else {
        // Check if supabase is initialized
        if (!supabaseClient) {
          console.error('Supabase not initialized');
          alert('Connection error. Please refresh the page.');
          return null;
        }
        // Fetch all recommendations except user's own
        const { data, error } = await supabaseClient
          .from('recommendations')
          .select('*')
          .neq('fingerprint', userFingerprint);
        
        if (error || !data || data.length === 0) {
          console.error('Error fetching:', error);
          // Fallback to any recommendation
          const { data: fallback } = await supabaseClient
            .from('recommendations')
            .select('*')
            .limit(50);
          if (fallback && fallback.length > 0) {
            return fallback[Math.floor(Math.random() * fallback.length)];
          }
          return null;
        }
        return data[Math.floor(Math.random() * data.length)];
      }
    }

    function generateAmazonLink(bookTitle) {
      // Extract just the book title (remove author if present)
      const searchTerm = encodeURIComponent(bookTitle);
      return `https://www.amazon.co.uk/s?k=${searchTerm}&tag=${AMAZON_AFFILIATE_TAG}`;
    }

    function copyLink() {
      const url = window.location.origin || 'https://broadside.press';
      navigator.clipboard.writeText(url).then(() => {
        const toast = document.getElementById('toast');
        toast.classList.add('show');
        setTimeout(() => toast.classList.remove('show'), 2000);
      }).catch(() => {
        // Fallback for older browsers
        const input = document.createElement('input');
        input.value = url;
        document.body.appendChild(input);
        input.select();
        document.execCommand('copy');
        document.body.removeChild(input);
        
        const toast = document.getElementById('toast');
        toast.classList.add('show');
        setTimeout(() => toast.classList.remove('show'), 2000);
      });
    }

    async function generateShareCard() {
      const canvas = document.getElementById('share-canvas');
      const ctx = canvas.getContext('2d');
      
      // Card dimensions (Instagram-friendly 1080x1350)
      const width = 1080;
      const height = 1350;
      canvas.width = width;
      canvas.height = height;
      
      // Colors
      const cream = '#f4f1ea';
      const ink = '#1a1614';
      const inkLight = '#2a2420';
      const red = '#8b2500';
      const gold = '#c4a747';
      
      // Background
      ctx.fillStyle = cream;
      ctx.fillRect(0, 0, width, height);
      
      // Add subtle texture (noise effect)
      ctx.globalAlpha = 0.03;
      for (let i = 0; i < 5000; i++) {
        ctx.fillStyle = Math.random() > 0.5 ? ink : cream;
        ctx.fillRect(
          Math.random() * width,
          Math.random() * height,
          1, 1
        );
      }
      ctx.globalAlpha = 1;
      
      // Outer border
      ctx.strokeStyle = ink;
      ctx.lineWidth = 4;
      ctx.strokeRect(40, 40, width - 80, height - 80);
      
      // Inner border
      ctx.lineWidth = 1;
      ctx.strokeRect(55, 55, width - 110, height - 110);
      
      // Corner ornaments
      const cornerSize = 20;
      const corners = [
        [70, 70], [width - 70, 70], 
        [70, height - 70], [width - 70, height - 70]
      ];
      ctx.fillStyle = red;
      corners.forEach(([x, y]) => {
        ctx.beginPath();
        ctx.moveTo(x, y - cornerSize/2);
        ctx.lineTo(x + cornerSize/2, y);
        ctx.lineTo(x, y + cornerSize/2);
        ctx.lineTo(x - cornerSize/2, y);
        ctx.closePath();
        ctx.fill();
      });
      
      // Header text - BROADSIDE
      ctx.fillStyle = ink;
      ctx.font = '700 72px Playfair Display, Georgia, serif';
      ctx.textAlign = 'center';
      ctx.letterSpacing = '0.15em';
      ctx.fillText('BROADSIDE', width/2, 160);
      
      // Tagline
      ctx.font = 'italic 28px Georgia, serif';
      ctx.fillStyle = inkLight;
      ctx.fillText('book recommendations from strangers', width/2, 210);
      
      // Decorative line under header
      ctx.strokeStyle = ink;
      ctx.lineWidth = 2;
      ctx.beginPath();
      ctx.moveTo(150, 250);
      ctx.lineTo(width - 150, 250);
      ctx.stroke();
      
      // Small diamonds on the line
      ctx.fillStyle = gold;
      [width/2 - 100, width/2, width/2 + 100].forEach(x => {
        ctx.beginPath();
        ctx.moveTo(x, 242);
        ctx.lineTo(x + 8, 250);
        ctx.lineTo(x, 258);
        ctx.lineTo(x - 8, 250);
        ctx.closePath();
        ctx.fill();
      });
      
      // Book title
      const bookTitle = document.getElementById('result-title').textContent;
      ctx.fillStyle = ink;
      ctx.font = '700 52px Playfair Display, Georgia, serif';
      
      // Word wrap for title
      const titleLines = wrapText(ctx, bookTitle, width - 200);
      let titleY = 380;
      titleLines.forEach(line => {
        ctx.fillText(line, width/2, titleY);
        titleY += 65;
      });
      
      // Decorative separator
      ctx.strokeStyle = inkLight;
      ctx.lineWidth = 1;
      ctx.beginPath();
      ctx.moveTo(300, titleY + 20);
      ctx.lineTo(width - 300, titleY + 20);
      ctx.stroke();
      
      // Quote/reason
      const reason = document.getElementById('result-reason').textContent;
      ctx.font = 'italic 36px Georgia, serif';
      ctx.fillStyle = inkLight;
      
      const reasonLines = wrapText(ctx, `"${reason}"`, width - 180);
      let reasonY = titleY + 90;
      reasonLines.forEach(line => {
        ctx.fillText(line, width/2, reasonY);
        reasonY += 50;
      });
      
      // Bottom decorative line
      ctx.strokeStyle = ink;
      ctx.lineWidth = 2;
      ctx.beginPath();
      ctx.moveTo(150, height - 220);
      ctx.lineTo(width - 150, height - 220);
      ctx.stroke();
      
      // Press icon (simplified)
      drawPressIcon(ctx, width/2, height - 150, gold, ink);
      
      // URL
      ctx.fillStyle = ink;
      ctx.font = '600 32px Playfair Display, Georgia, serif';
      ctx.fillText('broadside.press', width/2, height - 80);
      
      // Download the image
      const link = document.createElement('a');
      link.download = 'broadside-recommendation.png';
      link.href = canvas.toDataURL('image/png');
      link.click();
    }

    function wrapText(ctx, text, maxWidth) {
      const words = text.split(' ');
      const lines = [];
      let currentLine = '';
      
      words.forEach(word => {
        const testLine = currentLine + (currentLine ? ' ' : '') + word;
        const metrics = ctx.measureText(testLine);
        
        if (metrics.width > maxWidth && currentLine) {
          lines.push(currentLine);
          currentLine = word;
        } else {
          currentLine = testLine;
        }
      });
      
      if (currentLine) {
        lines.push(currentLine);
      }
      
      return lines;
    }

    function drawPressIcon(ctx, x, y, goldColor, inkColor) {
      ctx.save();
      ctx.translate(x - 30, y - 25);
      ctx.scale(0.8, 0.8);
      
      // Simplified press shape
      ctx.strokeStyle = goldColor;
      ctx.lineWidth = 2;
      
      // Base
      ctx.beginPath();
      ctx.moveTo(0, 50);
      ctx.lineTo(60, 50);
      ctx.stroke();
      
      // Uprights
      ctx.beginPath();
      ctx.moveTo(10, 50);
      ctx.lineTo(10, 15);
      ctx.moveTo(50, 50);
      ctx.lineTo(50, 15);
      ctx.stroke();
      
      // Top bar
      ctx.beginPath();
      ctx.moveTo(5, 15);
      ctx.lineTo(55, 15);
      ctx.stroke();
      
      // Platen
      ctx.beginPath();
      ctx.moveTo(15, 35);
      ctx.lineTo(45, 35);
      ctx.lineTo(48, 45);
      ctx.lineTo(12, 45);
      ctx.closePath();
      ctx.stroke();
      
      // Lever
      ctx.beginPath();
      ctx.moveTo(50, 15);
      ctx.lineTo(65, 0);
      ctx.stroke();
      
      // Handle ball
      ctx.beginPath();
      ctx.arc(67, -2, 5, 0, Math.PI * 2);
      ctx.fillStyle = goldColor;
      ctx.fill();
      
      ctx.restore();
    }

    function showView(viewId) {
      document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
      document.getElementById(viewId).classList.add('active');
      
      // Reset paper animation
      const paper = document.querySelector('#' + viewId + ' .paper-emerge');
      if (paper) {
        paper.style.animation = 'none';
        paper.offsetHeight; // Trigger reflow
        paper.style.animation = null;
      }
    }

    function updateCharCount(textarea) {
      document.getElementById('char-count').textContent = textarea.value.length;
    }

    async function submitRecommendation(event) {
      event.preventDefault();
      
      const title = document.getElementById('book-title').value.trim();
      const reason = document.getElementById('book-reason').value.trim();
      
      if (!title || !reason) return;
      
      // Animate lever
      const pressSvg = document.getElementById('press-svg');
      pressSvg.classList.add('pulled');
      
      // Show loading briefly
      setTimeout(() => {
        showView('loading-view');
        pressSvg.classList.remove('pulled');
      }, 400);
      
      // Save recommendation
      await saveRecommendation(title, reason);
      
      // Clear form
      document.getElementById('submit-form').reset();
      document.getElementById('char-count').textContent = '0';
      
      setTimeout(() => {
        showView('thankyou-view');
      }, 600);
    }

    async function findRecommendation() {
      // Animate lever
      const pressSvg = document.getElementById('press-svg');
      pressSvg.classList.add('pulled');
      
      setTimeout(() => {
        showView('loading-view');
        pressSvg.classList.remove('pulled');
      }, 400);
      
      // Fetch recommendation
      const rec = await getRandomRecommendation();
      
      setTimeout(() => {
        if (!rec) {
          alert('No recommendations found. Be the first to share one!');
          showView('home-view');
          return;
        }
        
        // Populate result
        document.getElementById('result-title').textContent = rec.title;
        document.getElementById('result-reason').textContent = rec.reason;
        document.getElementById('result-date').textContent = 'Pressed on ' + formatDate(rec.created_at);
        document.getElementById('amazon-link').href = generateAmazonLink(rec.title);
        
        showView('result-view');
      }, 800);
    }

    function formatDate(dateStr) {
      const date = new Date(dateStr);
      return date.toLocaleDateString('en-US', { 
        month: 'long', 
        day: 'numeric', 
        year: 'numeric' 
      });
    }

    // =====================
    // INIT
    // =====================
    
    document.addEventListener('DOMContentLoaded', async () => {
      userFingerprint = generateFingerprint();
      if (!USE_DEMO_MODE) {
        initSupabase();
      }
      
      // Register service worker for PWA
      if ('serviceWorker' in navigator) {
        try {
          const registration = await navigator.serviceWorker.register('/sw.js');
          console.log('ServiceWorker registered:', registration.scope);
        } catch (error) {
          console.log('ServiceWorker registration failed:', error);
        }
      }
    });
  </script>
</body>
</html>
